update-manifest:
  name: Update Deployment Manifest
  runs-on: ubuntu-latest
  needs: build-and-push

  steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Update image tag in manifest
      run: |
        sed -i "s|image: .*|image: docker.io/${{ github.repository_owner }}/app:${{ github.run_number }}|g" manifests/prod/deployment.yaml

    - name: Commit & push changes
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add manifests/prod/deployment.yaml
        git commit -m "Update image tag to docker.io/${{ github.repository_owner }}/app:${{ github.run_number }}"
        git push
